name: MacOS Nightly

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-nightly:
    name: Check for main branch changes
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    outputs:
      should_run: ${{ steps.decision.outputs.should_run }}
    steps:
      - name: Decide whether to run nightly build
        id: decision
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const eventName = context.eventName;
            if (eventName !== 'schedule') {
              core.info(`Event "${eventName}" triggered the workflow; proceeding with build.`);
              core.setOutput('should_run', 'true');
              return;
            }

            const { owner, repo } = context.repo;
            // FIXME NPI const workflowFile = 'macos-nightly.yml';
            const workflowFile = 'macos-release.yml';

            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowFile,
              branch: 'main',
              status: 'success',
              per_page: 1,
            });

            if (!runs.data.workflow_runs.length) {
              core.info('No previous successful nightly runs found; building.');
              core.setOutput('should_run', 'true');
              return;
            }

            const lastRun = runs.data.workflow_runs[0];
            const lastSha = lastRun.head_sha;
            core.info(`Last successful nightly run used commit ${lastSha}. Current commit is ${context.sha}.`);

            if (lastSha === context.sha) {
              core.info('Latest commit already built in the previous nightly run; skipping.');
              core.setOutput('should_run', 'false');
              return;
            }

            try {
              const comparison = await github.rest.repos.compareCommits({
                owner,
                repo,
                base: lastSha,
                head: context.sha,
              });

              core.info(`Comparison status: ${comparison.data.status}. Ahead by ${comparison.data.ahead_by} commits.`);

              if (comparison.data.status === 'identical' || comparison.data.ahead_by === 0) {
                core.info('No new commits on main since the previous nightly; skipping build.');
                core.setOutput('should_run', 'false');
                return;
              }

              core.info('Detected new commits on main since the last nightly; proceeding with build.');
              core.setOutput('should_run', 'true');
            } catch (error) {
              core.warning(`Failed to compare commits due to: ${error.message}. Proceeding with build.`);
              core.setOutput('should_run', 'true');
            }

  prepare-nightly:
    name: Prepare nightly version
    runs-on: ubuntu-latest
    needs: check-nightly
    if: needs.check-nightly.outputs.should_run == 'true'
    outputs:
      nightly_version: ${{ steps.set_version.outputs.nightly_version }}
    steps:
      - name: Compute APP_VERSION
        id: set_version
        run: |
          APP_VERSION=$(date -u +%d.%m.%Y)
          echo "nightly_version=$APP_VERSION" >> $GITHUB_OUTPUT

  build-nightly:
    name: Build nightly distributable
    needs: prepare-nightly
    uses: ./.github/workflows/macos-build.yml
    with:
      version: ${{ needs.prepare-nightly.outputs.nightly_version }}

  release:
    name: Release nightly
    needs:
    - build-nightly
    - prepare-nightly # to get access to nightly_version output
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Print version
        run: |
          echo "Version: '${{ needs.prepare-nightly.outputs.nightly_version }}'"
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nighlty/${{ needs.prepare-nightly.outputs.nightly_version }}
          name: Nightly v${{ needs.prepare-nightly.outputs.nightly_version }}
          body: ${{ github.event.inputs.release_notes }}
          draft: false
          prerelease: true
          files: ${{ needs.build.outputs.zip_path }}
